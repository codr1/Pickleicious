// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: cancellation_policies.sql

package db

import (
	"context"
	"database/sql"
	"time"
)

const createCancellationPolicyTier = `-- name: CreateCancellationPolicyTier :one
INSERT INTO cancellation_policy_tiers (
    facility_id,
    reservation_type_id,
    min_hours_before,
    refund_percentage
) VALUES (
    ?1,
    ?2,
    ?3,
    ?4
)
RETURNING
    id,
    facility_id,
    reservation_type_id,
    min_hours_before,
    refund_percentage,
    created_at,
    updated_at
`

type CreateCancellationPolicyTierParams struct {
	FacilityID        int64         `json:"facilityId"`
	ReservationTypeID sql.NullInt64 `json:"reservationTypeId"`
	MinHoursBefore    int64         `json:"minHoursBefore"`
	RefundPercentage  int64         `json:"refundPercentage"`
}

func (q *Queries) CreateCancellationPolicyTier(ctx context.Context, arg CreateCancellationPolicyTierParams) (CancellationPolicyTier, error) {
	row := q.queryRow(ctx, q.createCancellationPolicyTierStmt, createCancellationPolicyTier,
		arg.FacilityID,
		arg.ReservationTypeID,
		arg.MinHoursBefore,
		arg.RefundPercentage,
	)
	var i CancellationPolicyTier
	err := row.Scan(
		&i.ID,
		&i.FacilityID,
		&i.ReservationTypeID,
		&i.MinHoursBefore,
		&i.RefundPercentage,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const deleteCancellationPolicyTier = `-- name: DeleteCancellationPolicyTier :execrows
DELETE FROM cancellation_policy_tiers
WHERE id = ?1
  AND facility_id = ?2
`

type DeleteCancellationPolicyTierParams struct {
	ID         int64 `json:"id"`
	FacilityID int64 `json:"facilityId"`
}

func (q *Queries) DeleteCancellationPolicyTier(ctx context.Context, arg DeleteCancellationPolicyTierParams) (int64, error) {
	result, err := q.exec(ctx, q.deleteCancellationPolicyTierStmt, deleteCancellationPolicyTier, arg.ID, arg.FacilityID)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const getApplicableCancellationTier = `-- name: GetApplicableCancellationTier :one
SELECT
    id,
    facility_id,
    reservation_type_id,
    min_hours_before,
    refund_percentage,
    created_at,
    updated_at
FROM cancellation_policy_tiers cpt
WHERE cpt.facility_id = ?1
  AND cpt.min_hours_before <= ?2
  AND (
    cpt.reservation_type_id = ?3
    OR cpt.reservation_type_id IS NULL
  )
ORDER BY
    CASE WHEN cpt.reservation_type_id IS NULL THEN 1 ELSE 0 END,
    cpt.min_hours_before DESC
LIMIT 1
`

type GetApplicableCancellationTierParams struct {
	FacilityID            int64         `json:"facilityId"`
	HoursUntilReservation int64         `json:"hoursUntilReservation"`
	ReservationTypeID     sql.NullInt64 `json:"reservationTypeId"`
}

// Prefer type-specific tiers over defaults, then pick the highest hours threshold.
func (q *Queries) GetApplicableCancellationTier(ctx context.Context, arg GetApplicableCancellationTierParams) (CancellationPolicyTier, error) {
	row := q.queryRow(ctx, q.getApplicableCancellationTierStmt, getApplicableCancellationTier, arg.FacilityID, arg.HoursUntilReservation, arg.ReservationTypeID)
	var i CancellationPolicyTier
	err := row.Scan(
		&i.ID,
		&i.FacilityID,
		&i.ReservationTypeID,
		&i.MinHoursBefore,
		&i.RefundPercentage,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getCancellationPolicyTier = `-- name: GetCancellationPolicyTier :one
SELECT
    id,
    facility_id,
    reservation_type_id,
    min_hours_before,
    refund_percentage,
    created_at,
    updated_at
FROM cancellation_policy_tiers
WHERE id = ?1
  AND facility_id = ?2
`

type GetCancellationPolicyTierParams struct {
	ID         int64 `json:"id"`
	FacilityID int64 `json:"facilityId"`
}

func (q *Queries) GetCancellationPolicyTier(ctx context.Context, arg GetCancellationPolicyTierParams) (CancellationPolicyTier, error) {
	row := q.queryRow(ctx, q.getCancellationPolicyTierStmt, getCancellationPolicyTier, arg.ID, arg.FacilityID)
	var i CancellationPolicyTier
	err := row.Scan(
		&i.ID,
		&i.FacilityID,
		&i.ReservationTypeID,
		&i.MinHoursBefore,
		&i.RefundPercentage,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getLatestCancellationByReservationID = `-- name: GetLatestCancellationByReservationID :one
SELECT
    id,
    reservation_id,
    cancelled_by_user_id,
    cancelled_at,
    refund_percentage_applied,
    fee_waived,
    hours_before_start,
    created_at
FROM reservation_cancellations
WHERE reservation_id = ?1
ORDER BY cancelled_at DESC
LIMIT 1
`

func (q *Queries) GetLatestCancellationByReservationID(ctx context.Context, reservationID int64) (ReservationCancellation, error) {
	row := q.queryRow(ctx, q.getLatestCancellationByReservationIDStmt, getLatestCancellationByReservationID, reservationID)
	var i ReservationCancellation
	err := row.Scan(
		&i.ID,
		&i.ReservationID,
		&i.CancelledByUserID,
		&i.CancelledAt,
		&i.RefundPercentageApplied,
		&i.FeeWaived,
		&i.HoursBeforeStart,
		&i.CreatedAt,
	)
	return i, err
}

const listCancellationPolicyTiers = `-- name: ListCancellationPolicyTiers :many
SELECT
    id,
    facility_id,
    reservation_type_id,
    min_hours_before,
    refund_percentage,
    created_at,
    updated_at
FROM cancellation_policy_tiers
WHERE facility_id = ?1
  AND (?2 IS NULL OR reservation_type_id = ?2)
ORDER BY
    reservation_type_id IS NULL,
    reservation_type_id,
    min_hours_before DESC
`

type ListCancellationPolicyTiersParams struct {
	FacilityID        int64       `json:"facilityId"`
	ReservationTypeID interface{} `json:"reservationTypeId"`
}

func (q *Queries) ListCancellationPolicyTiers(ctx context.Context, arg ListCancellationPolicyTiersParams) ([]CancellationPolicyTier, error) {
	rows, err := q.query(ctx, q.listCancellationPolicyTiersStmt, listCancellationPolicyTiers, arg.FacilityID, arg.ReservationTypeID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []CancellationPolicyTier
	for rows.Next() {
		var i CancellationPolicyTier
		if err := rows.Scan(
			&i.ID,
			&i.FacilityID,
			&i.ReservationTypeID,
			&i.MinHoursBefore,
			&i.RefundPercentage,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const logCancellation = `-- name: LogCancellation :one
INSERT INTO reservation_cancellations (
    reservation_id,
    cancelled_by_user_id,
    cancelled_at,
    refund_percentage_applied,
    fee_waived,
    hours_before_start
) VALUES (
    ?1,
    ?2,
    ?3,
    ?4,
    ?5,
    ?6
)
RETURNING
    id,
    reservation_id,
    cancelled_by_user_id,
    cancelled_at,
    refund_percentage_applied,
    fee_waived,
    hours_before_start,
    created_at
`

type LogCancellationParams struct {
	ReservationID           int64     `json:"reservationId"`
	CancelledByUserID       int64     `json:"cancelledByUserId"`
	CancelledAt             time.Time `json:"cancelledAt"`
	RefundPercentageApplied int64     `json:"refundPercentageApplied"`
	FeeWaived               bool      `json:"feeWaived"`
	HoursBeforeStart        int64     `json:"hoursBeforeStart"`
}

func (q *Queries) LogCancellation(ctx context.Context, arg LogCancellationParams) (ReservationCancellation, error) {
	row := q.queryRow(ctx, q.logCancellationStmt, logCancellation,
		arg.ReservationID,
		arg.CancelledByUserID,
		arg.CancelledAt,
		arg.RefundPercentageApplied,
		arg.FeeWaived,
		arg.HoursBeforeStart,
	)
	var i ReservationCancellation
	err := row.Scan(
		&i.ID,
		&i.ReservationID,
		&i.CancelledByUserID,
		&i.CancelledAt,
		&i.RefundPercentageApplied,
		&i.FeeWaived,
		&i.HoursBeforeStart,
		&i.CreatedAt,
	)
	return i, err
}

const updateCancellationPolicyTier = `-- name: UpdateCancellationPolicyTier :one
UPDATE cancellation_policy_tiers
SET min_hours_before = ?1,
    reservation_type_id = ?2,
    refund_percentage = ?3,
    updated_at = CURRENT_TIMESTAMP
WHERE id = ?4
  AND facility_id = ?5
RETURNING
    id,
    facility_id,
    reservation_type_id,
    min_hours_before,
    refund_percentage,
    created_at,
    updated_at
`

type UpdateCancellationPolicyTierParams struct {
	MinHoursBefore    int64         `json:"minHoursBefore"`
	ReservationTypeID sql.NullInt64 `json:"reservationTypeId"`
	RefundPercentage  int64         `json:"refundPercentage"`
	ID                int64         `json:"id"`
	FacilityID        int64         `json:"facilityId"`
}

func (q *Queries) UpdateCancellationPolicyTier(ctx context.Context, arg UpdateCancellationPolicyTierParams) (CancellationPolicyTier, error) {
	row := q.queryRow(ctx, q.updateCancellationPolicyTierStmt, updateCancellationPolicyTier,
		arg.MinHoursBefore,
		arg.ReservationTypeID,
		arg.RefundPercentage,
		arg.ID,
		arg.FacilityID,
	)
	var i CancellationPolicyTier
	err := row.Scan(
		&i.ID,
		&i.FacilityID,
		&i.ReservationTypeID,
		&i.MinHoursBefore,
		&i.RefundPercentage,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}
