// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: visit_packs.sql

package db

import (
	"context"
	"database/sql"
	"time"
)

const countVisitPackTypesByFacility = `-- name: CountVisitPackTypesByFacility :one
SELECT COUNT(*)
FROM visit_pack_types
WHERE facility_id = ?1
`

func (q *Queries) CountVisitPackTypesByFacility(ctx context.Context, facilityID int64) (int64, error) {
	row := q.queryRow(ctx, q.countVisitPackTypesByFacilityStmt, countVisitPackTypesByFacility, facilityID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createVisitPack = `-- name: CreateVisitPack :one
INSERT INTO visit_packs (
    pack_type_id,
    user_id,
    purchase_date,
    expires_at,
    visits_remaining,
    status
)
SELECT
    vpt.id,
    ?1,
    ?2,
    datetime(?2, '+' || vpt.valid_days || ' days'),
    vpt.visit_count,
    ?3
FROM visit_pack_types vpt
WHERE vpt.id = ?4
  AND vpt.status = 'active'
RETURNING id, pack_type_id, user_id, purchase_date, expires_at,
    visits_remaining, status, created_at, updated_at
`

type CreateVisitPackParams struct {
	UserID       int64     `json:"userId"`
	PurchaseDate time.Time `json:"purchaseDate"`
	Status       string    `json:"status"`
	PackTypeID   int64     `json:"packTypeId"`
}

func (q *Queries) CreateVisitPack(ctx context.Context, arg CreateVisitPackParams) (VisitPack, error) {
	row := q.queryRow(ctx, q.createVisitPackStmt, createVisitPack,
		arg.UserID,
		arg.PurchaseDate,
		arg.Status,
		arg.PackTypeID,
	)
	var i VisitPack
	err := row.Scan(
		&i.ID,
		&i.PackTypeID,
		&i.UserID,
		&i.PurchaseDate,
		&i.ExpiresAt,
		&i.VisitsRemaining,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const createVisitPackRedemption = `-- name: CreateVisitPackRedemption :one
INSERT INTO visit_pack_redemptions (
    visit_pack_id,
    facility_id,
    redeemed_at,
    reservation_id
) VALUES (
    ?1,
    ?2,
    ?3,
    ?4
)
RETURNING id, visit_pack_id, facility_id, redeemed_at, reservation_id, created_at
`

type CreateVisitPackRedemptionParams struct {
	VisitPackID   int64         `json:"visitPackId"`
	FacilityID    int64         `json:"facilityId"`
	RedeemedAt    time.Time     `json:"redeemedAt"`
	ReservationID sql.NullInt64 `json:"reservationId"`
}

func (q *Queries) CreateVisitPackRedemption(ctx context.Context, arg CreateVisitPackRedemptionParams) (VisitPackRedemption, error) {
	row := q.queryRow(ctx, q.createVisitPackRedemptionStmt, createVisitPackRedemption,
		arg.VisitPackID,
		arg.FacilityID,
		arg.RedeemedAt,
		arg.ReservationID,
	)
	var i VisitPackRedemption
	err := row.Scan(
		&i.ID,
		&i.VisitPackID,
		&i.FacilityID,
		&i.RedeemedAt,
		&i.ReservationID,
		&i.CreatedAt,
	)
	return i, err
}

const createVisitPackType = `-- name: CreateVisitPackType :one

INSERT INTO visit_pack_types (
    facility_id,
    name,
    price_cents,
    visit_count,
    valid_days,
    status
) VALUES (
    ?1,
    ?2,
    ?3,
    ?4,
    ?5,
    ?6
)
RETURNING id, facility_id, name, price_cents, visit_count, valid_days, status,
    created_at, updated_at
`

type CreateVisitPackTypeParams struct {
	FacilityID int64  `json:"facilityId"`
	Name       string `json:"name"`
	PriceCents int64  `json:"priceCents"`
	VisitCount int64  `json:"visitCount"`
	ValidDays  int64  `json:"validDays"`
	Status     string `json:"status"`
}

// internal/db/queries/visit_packs.sql
func (q *Queries) CreateVisitPackType(ctx context.Context, arg CreateVisitPackTypeParams) (VisitPackType, error) {
	row := q.queryRow(ctx, q.createVisitPackTypeStmt, createVisitPackType,
		arg.FacilityID,
		arg.Name,
		arg.PriceCents,
		arg.VisitCount,
		arg.ValidDays,
		arg.Status,
	)
	var i VisitPackType
	err := row.Scan(
		&i.ID,
		&i.FacilityID,
		&i.Name,
		&i.PriceCents,
		&i.VisitCount,
		&i.ValidDays,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const deactivateVisitPackType = `-- name: DeactivateVisitPackType :one
UPDATE visit_pack_types
SET status = 'inactive',
    updated_at = CURRENT_TIMESTAMP
WHERE id = ?1
  AND facility_id = ?2
RETURNING id, facility_id, name, price_cents, visit_count, valid_days, status,
    created_at, updated_at
`

type DeactivateVisitPackTypeParams struct {
	ID         int64 `json:"id"`
	FacilityID int64 `json:"facilityId"`
}

func (q *Queries) DeactivateVisitPackType(ctx context.Context, arg DeactivateVisitPackTypeParams) (VisitPackType, error) {
	row := q.queryRow(ctx, q.deactivateVisitPackTypeStmt, deactivateVisitPackType, arg.ID, arg.FacilityID)
	var i VisitPackType
	err := row.Scan(
		&i.ID,
		&i.FacilityID,
		&i.Name,
		&i.PriceCents,
		&i.VisitCount,
		&i.ValidDays,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const decrementVisitPackVisit = `-- name: DecrementVisitPackVisit :one
UPDATE visit_packs
SET visits_remaining = visits_remaining - 1,
    status = CASE
        WHEN visits_remaining - 1 <= 0 THEN 'depleted'
        ELSE status
    END,
    updated_at = CURRENT_TIMESTAMP
WHERE id = ?1
  AND status = 'active'
  AND visits_remaining > 0
RETURNING id, pack_type_id, user_id, purchase_date, expires_at,
    visits_remaining, status, created_at, updated_at
`

func (q *Queries) DecrementVisitPackVisit(ctx context.Context, id int64) (VisitPack, error) {
	row := q.queryRow(ctx, q.decrementVisitPackVisitStmt, decrementVisitPackVisit, id)
	var i VisitPack
	err := row.Scan(
		&i.ID,
		&i.PackTypeID,
		&i.UserID,
		&i.PurchaseDate,
		&i.ExpiresAt,
		&i.VisitsRemaining,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getVisitPack = `-- name: GetVisitPack :one
SELECT id, pack_type_id, user_id, purchase_date, expires_at,
    visits_remaining, status, created_at, updated_at
FROM visit_packs
WHERE id = ?1
  AND user_id = ?2
`

type GetVisitPackParams struct {
	ID     int64 `json:"id"`
	UserID int64 `json:"userId"`
}

func (q *Queries) GetVisitPack(ctx context.Context, arg GetVisitPackParams) (VisitPack, error) {
	row := q.queryRow(ctx, q.getVisitPackStmt, getVisitPack, arg.ID, arg.UserID)
	var i VisitPack
	err := row.Scan(
		&i.ID,
		&i.PackTypeID,
		&i.UserID,
		&i.PurchaseDate,
		&i.ExpiresAt,
		&i.VisitsRemaining,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getVisitPackType = `-- name: GetVisitPackType :one
SELECT id, facility_id, name, price_cents, visit_count, valid_days, status,
    created_at, updated_at
FROM visit_pack_types
WHERE id = ?1
  AND facility_id = ?2
`

type GetVisitPackTypeParams struct {
	ID         int64 `json:"id"`
	FacilityID int64 `json:"facilityId"`
}

func (q *Queries) GetVisitPackType(ctx context.Context, arg GetVisitPackTypeParams) (VisitPackType, error) {
	row := q.queryRow(ctx, q.getVisitPackTypeStmt, getVisitPackType, arg.ID, arg.FacilityID)
	var i VisitPackType
	err := row.Scan(
		&i.ID,
		&i.FacilityID,
		&i.Name,
		&i.PriceCents,
		&i.VisitCount,
		&i.ValidDays,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const listActiveVisitPacksForUser = `-- name: ListActiveVisitPacksForUser :many
SELECT id, pack_type_id, user_id, purchase_date, expires_at,
    visits_remaining, status, created_at, updated_at
FROM visit_packs
WHERE user_id = ?1
  AND status = 'active'
  AND visits_remaining > 0
  AND expires_at > ?2
ORDER BY expires_at
`

type ListActiveVisitPacksForUserParams struct {
	UserID         int64     `json:"userId"`
	ComparisonTime time.Time `json:"comparisonTime"`
}

func (q *Queries) ListActiveVisitPacksForUser(ctx context.Context, arg ListActiveVisitPacksForUserParams) ([]VisitPack, error) {
	rows, err := q.query(ctx, q.listActiveVisitPacksForUserStmt, listActiveVisitPacksForUser, arg.UserID, arg.ComparisonTime)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []VisitPack
	for rows.Next() {
		var i VisitPack
		if err := rows.Scan(
			&i.ID,
			&i.PackTypeID,
			&i.UserID,
			&i.PurchaseDate,
			&i.ExpiresAt,
			&i.VisitsRemaining,
			&i.Status,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listVisitPackTypes = `-- name: ListVisitPackTypes :many
SELECT id, facility_id, name, price_cents, visit_count, valid_days, status,
    created_at, updated_at
FROM visit_pack_types
WHERE facility_id = ?1
ORDER BY name
`

func (q *Queries) ListVisitPackTypes(ctx context.Context, facilityID int64) ([]VisitPackType, error) {
	rows, err := q.query(ctx, q.listVisitPackTypesStmt, listVisitPackTypes, facilityID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []VisitPackType
	for rows.Next() {
		var i VisitPackType
		if err := rows.Scan(
			&i.ID,
			&i.FacilityID,
			&i.Name,
			&i.PriceCents,
			&i.VisitCount,
			&i.ValidDays,
			&i.Status,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateVisitPackType = `-- name: UpdateVisitPackType :one
UPDATE visit_pack_types
SET name = ?1,
    price_cents = ?2,
    visit_count = ?3,
    valid_days = ?4,
    updated_at = CURRENT_TIMESTAMP
WHERE id = ?5
  AND facility_id = ?6
RETURNING id, facility_id, name, price_cents, visit_count, valid_days, status,
    created_at, updated_at
`

type UpdateVisitPackTypeParams struct {
	Name       string `json:"name"`
	PriceCents int64  `json:"priceCents"`
	VisitCount int64  `json:"visitCount"`
	ValidDays  int64  `json:"validDays"`
	ID         int64  `json:"id"`
	FacilityID int64  `json:"facilityId"`
}

func (q *Queries) UpdateVisitPackType(ctx context.Context, arg UpdateVisitPackTypeParams) (VisitPackType, error) {
	row := q.queryRow(ctx, q.updateVisitPackTypeStmt, updateVisitPackType,
		arg.Name,
		arg.PriceCents,
		arg.VisitCount,
		arg.ValidDays,
		arg.ID,
		arg.FacilityID,
	)
	var i VisitPackType
	err := row.Scan(
		&i.ID,
		&i.FacilityID,
		&i.Name,
		&i.PriceCents,
		&i.VisitCount,
		&i.ValidDays,
		&i.Status,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}
